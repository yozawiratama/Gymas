generator client {
  provider = "prisma-client-js"
  output   = "../src/lib/server/db/prisma-server"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum LegacyUserRole {
  SUPER_ADMIN
  OWNER
  ADMIN
  STAFF
  FRONTDESK
}

enum MemberStatus {
  ACTIVE
  INACTIVE
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  OTHER
}

enum PaymentStatus {
  PAID
  VOID
  REFUNDED
}

enum AttendanceSource {
  MANUAL
  AUTO
}

enum OutboxStatus {
  PENDING
  SENDING
  ACKED
  FAILED
}

enum ProcessedEventStatus {
  ACKED
  REJECTED
}

model User {
  id           String         @id @default(cuid())
  username     String         @unique
  passwordHash String
  role         LegacyUserRole @default(STAFF)
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  sessions     Session[]
  loginHistory LoginHistory[]
  userRoles    UserRole[]
  auditLogs    AuditLog[]     @relation("AuditLogActor")
  createdNotes MemberNote[]   @relation("UserNotes")
  createdFlags MemberFlag[]   @relation("UserFlags")
  createdMemberships MemberMembership[] @relation("MembershipCreatedBy")
  paymentsCreated Payment[]   @relation("PaymentCreatedBy")
  paymentsVoided Payment[]    @relation("PaymentDeletedBy")
  createdPersonalTrainers PersonalTrainer[] @relation("PersonalTrainerCreatedBy")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users        UserRole[]
  permissions  RolePermission[]
}

model Permission {
  id          String   @id @default(cuid())
  key         String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles RolePermission[]
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model LoginHistory {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  usernameAttempt String?
  occurredAt DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  success    Boolean  @default(true)

  @@index([userId, occurredAt])
  @@index([usernameAttempt, occurredAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  actorUserId String?
  actorUser   User?    @relation("AuditLogActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  entityType  String?
  entityId    String?
  metaJson    Json?
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([actorUserId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
}

model Session {
  id         String   @id
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  lastSeenAt DateTime?
  userAgent  String?
  ipAddress  String?

  @@index([userId])
  @@index([expiresAt])
}

model Branch {
  id        String   @id @default(cuid())
  name      String
  code      String?  @unique
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  members          Member[]
  attendances      Attendance[]
  payments         Payment[]
  media            Media[]
  settings         AppSetting[]
  membershipPlans  MembershipPlan[]
  memberships      MemberMembership[]
  personalTrainers PersonalTrainer[]

  @@index([isActive])
}

model PersonalTrainer {
  id              String   @id @default(cuid())
  branchId         String
  branch           Branch  @relation(fields: [branchId], references: [id])
  fullName         String
  displayName      String?
  phone            String?
  email            String?
  bio              String?  @db.Text
  specialty        String?
  photoMediaId     String?
  photoMedia       Media?   @relation("PersonalTrainerPhoto", fields: [photoMediaId], references: [id])
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdByUserId  String?
  createdByUser    User?    @relation("PersonalTrainerCreatedBy", fields: [createdByUserId], references: [id])

  @@index([branchId])
  @@index([branchId, isActive])
  @@index([fullName])
}

model Member {
  id         String        @id @default(cuid())
  memberCode String        @unique
  branchId   String
  firstName  String
  lastName   String
  email      String?
  phone      String?
  status     MemberStatus  @default(ACTIVE)
  isFrozen   Boolean       @default(false)
  joinedAt   DateTime      @default(now())
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  branch     Branch        @relation(fields: [branchId], references: [id], onDelete: Restrict)
  attendance Attendance[]
  payments   Payment[]
  memberships MemberMembership[]
  tags       MemberTag[]
  notes      MemberNote[]
  flags      MemberFlag[]
  media      Media[]

  @@index([branchId])
  @@index([branchId, createdAt])
}

model Attendance {
  id             String           @id @default(cuid())
  memberId       String
  branchId       String
  membershipId   String?
  member         Member           @relation(fields: [memberId], references: [id], onDelete: Cascade)
  branch         Branch           @relation(fields: [branchId], references: [id], onDelete: Restrict)
  membership     MemberMembership? @relation(fields: [membershipId], references: [id], onDelete: SetNull)
  checkInAt      DateTime         @default(now())
  checkOutAt     DateTime?
  source         AttendanceSource @default(MANUAL)
  memberSnapshot Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([memberId, checkInAt])
  @@index([branchId, checkInAt])
  @@index([membershipId])
  @@index([branchId])
  @@index([checkInAt])
}

model Payment {
  id              String        @id @default(cuid())
  memberId        String
  membershipId    String?
  branchId        String
  member          Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  membership      MemberMembership? @relation(fields: [membershipId], references: [id], onDelete: SetNull)
  branch          Branch        @relation(fields: [branchId], references: [id], onDelete: Restrict)
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")
  method          PaymentMethod @default(CASH)
  status          PaymentStatus @default(PAID)
  note            String?
  paidAt          DateTime      @default(now())
  createdAt       DateTime      @default(now())
  createdByUserId String
  createdBy       User          @relation("PaymentCreatedBy", fields: [createdByUserId], references: [id])
  deletedAt       DateTime?
  deletedByUserId String?
  deletedBy       User?         @relation("PaymentDeletedBy", fields: [deletedByUserId], references: [id], onDelete: SetNull)
  voidReason      String?       @db.Text
  updatedAt       DateTime      @updatedAt

  @@index([memberId, paidAt])
  @@index([membershipId])
  @@index([branchId, paidAt])
  @@index([branchId, createdAt])
  @@index([branchId])
  @@index([paidAt])
  @@index([createdAt])
}

model MembershipPlan {
  id           String   @id @default(cuid())
  name         String
  branchId     String
  durationDays Int
  priceCents   Int?
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  branch       Branch   @relation(fields: [branchId], references: [id], onDelete: Restrict)
  memberships  MemberMembership[]

  @@index([branchId, isActive])
  @@index([branchId])
}

model MemberMembership {
  id              String   @id @default(cuid())
  memberId        String
  planId          String
  branchId        String
  startAt         DateTime
  endAt           DateTime
  cancelledAt     DateTime?
  cancelReason    String?  @db.Text
  createdAt       DateTime @default(now())
  createdByUserId String

  member          Member         @relation(fields: [memberId], references: [id], onDelete: Cascade)
  plan            MembershipPlan @relation(fields: [planId], references: [id], onDelete: Restrict)
  branch          Branch         @relation(fields: [branchId], references: [id], onDelete: Restrict)
  createdBy       User           @relation("MembershipCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  payments        Payment[]
  attendances     Attendance[]

  @@index([memberId, endAt])
  @@index([planId])
  @@index([branchId, endAt])
  @@index([branchId])
}

model Tag {
  id        String      @id @default(cuid())
  name      String      @unique
  color     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  members   MemberTag[]
}

model MemberTag {
  memberId   String
  tagId      String
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@id([memberId, tagId])
  @@index([tagId])
}

model MemberNote {
  id              String   @id @default(cuid())
  memberId        String
  createdByUserId String?
  member          Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  createdBy       User?    @relation("UserNotes", fields: [createdByUserId], references: [id], onDelete: SetNull)
  note            String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([memberId, createdAt])
}

model MemberFlag {
  id              String   @id @default(cuid())
  memberId        String
  createdByUserId String?
  member          Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  createdBy       User?    @relation("UserFlags", fields: [createdByUserId], references: [id], onDelete: SetNull)
  flag            String
  description     String?
  createdAt       DateTime @default(now())
  resolvedAt      DateTime?

  @@index([memberId, createdAt])
}

model Media {
  id        String   @id @default(cuid())
  memberId  String?
  branchId  String
  member    Member?  @relation(fields: [memberId], references: [id], onDelete: SetNull)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Restrict)
  kind      String
  uri       String
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime @default(now())

  personalTrainersAsPhoto PersonalTrainer[] @relation("PersonalTrainerPhoto")

  @@index([memberId])
  @@index([branchId])
}

model AppSetting {
  branchId  String
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Restrict)

  @@id([branchId, key])
}

model SitePage {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  contentMarkdown String   @db.Text
  published       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
}

model OutboxEvent {
  id             String       @id @default(cuid())
  type           String
  payload        Json
  idempotencyKey String       @unique
  status         OutboxStatus @default(PENDING)
  attempts       Int          @default(0)
  nextAttemptAt  DateTime?
  lastAttemptAt  DateTime?
  lastError      String?      @db.VarChar(500)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([status])
  @@index([nextAttemptAt])
  @@index([createdAt])
}

model ProcessedEvent {
  id             String               @id @default(cuid())
  idempotencyKey String               @unique
  eventId        String
  eventType      String
  deviceId       String?
  gymId          String?
  processedAt    DateTime             @default(now())
  status         ProcessedEventStatus
  result         Json?

  @@unique([deviceId, eventId])
  @@index([processedAt])
  @@index([eventType])
}
